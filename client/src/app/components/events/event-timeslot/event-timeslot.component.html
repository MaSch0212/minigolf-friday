<div class="flex h-full w-full max-w-[40rem] flex-col gap-4">
  <p-button
    [label]="translations.events_backToEvents()"
    [text]="true"
    icon="i-[mdi--arrow-left]"
    (onClick)="navigateBack()"
  />

  @if (isBusy()) {
    <p-progressSpinner class="m-8 self-center" />
  } @else if (hasFailed()) {
    <p-messages severity="error">
      <ng-template pTemplate>
        <span class="i-[mdi--close-circle-outline] mr-2"></span>
        <span
          >{{ translations.events_error_loadOne() }} {{ translations.shared_tryAgainLater() }}</span
        >
      </ng-template>
    </p-messages>
  } @else {
    @if (hasUsersFailed()) {
      <p-messages severity="error">
        <ng-template pTemplate>
          <span class="i-[mdi--close-circle-outline] mr-2"></span>
          <span
            >{{ translations.users_error_load() }} {{ translations.shared_tryAgainLater() }}</span
          >
          <p-button
            pTooltip="retry"
            [text]="true"
            icon="i-[mdi--reload]"
            (onClick)="reloadUsers()"
          />
        </ng-template>
      </p-messages>
    }

    @if (event(); as event) {
      @if (timeslot(); as timeslot) {
        <p-card>
          <div class="flex flex-col items-center">
            <div class="grid grid-cols-[auto,1fr] gap-x-4 gap-y-2">
              <div class="truncate text-right font-semibold">{{ translations.events_date() }}:</div>
              <div>{{ dateTime() | date: 'medium' : undefined : locale() }}</div>
              <div class="truncate font-semibold">
                {{ translations.events_registrationDeadline() }}:
              </div>
              <div>{{ event.registrationDeadline | date: 'medium' : undefined : locale() }}</div>
            </div>
          </div>
        </p-card>

        <div class="flex grow flex-col gap-4 overflow-auto">
          @if (isUsersBusy()) {
            <p-progressSpinner class="m-4 self-center" styleClass="w-16 h-16" strokeWidth="4" />
          } @else if (!hasUsersFailed()) {
            <div class="mt-4 flex flex-row items-center gap-2">
              <h2 class="m-0 grow">
                {{ translations.events_timeslot_preconfiguredGroups() }}
              </h2>
              <p-button
                [label]="translations.shared_add()"
                icon="i-[mdi--plus]"
                [disabled]="isAddPreconfigBusy()"
                (onClick)="addPreconfig()"
              />
            </div>

            @if (timeslot.preconfigurations.length === 0) {
              <div
                class="rounded-lg border-[1px] border-solid border-surface-d bg-surface-a px-4 py-2 text-center leading-8"
              >
                {{ translations.events_timeslot_noPreconfigurations() }}
              </div>
            } @else {
              <p-accordion>
                @for (preconfig of timeslot.preconfigurations; track preconfig.id) {
                  <p-accordionTab contentStyleClass="p-0">
                    <ng-template pTemplate="header">
                      <span class="flex w-full flex-row items-center gap-2">
                        <span class="min-w-0 grow truncate">{{
                          translations.events_playerAmount()
                            | interpolate: { amount: preconfig.playerIds.length }
                        }}</span>
                        <p-button
                          class="-my-2"
                          [pTooltip]="translations.shared_delete()"
                          [text]="true"
                          [rounded]="true"
                          [severity]="'danger'"
                          size="small"
                          icon="i-[mdi--delete-outline]"
                          (onClick)="$event.stopImmediatePropagation(); removePreconfig(preconfig)"
                        />
                      </span>
                    </ng-template>

                    @for (playerId of preconfig.playerIds; track playerId; let index = $index) {
                      <div
                        class="flex min-w-0 flex-row items-center border-0 border-b-[1px] border-solid border-surface-d py-2 pl-4 pr-2 leading-8 hover:bg-surface-c"
                      >
                        <span class="truncate">
                          @if (allUsers()[playerId]; as user) {
                            {{ user.name }}
                          } @else {
                            &lt;{{ translations.events_timeslot_unknownPlayer() }}&gt;
                            <span class="opacity-50">({{ playerId }})</span>
                          }
                        </span>
                        <div class="grow"></div>
                        <p-button
                          class="mr-3"
                          [pTooltip]="translations.shared_delete()"
                          [text]="true"
                          [rounded]="true"
                          [severity]="'danger'"
                          size="small"
                          icon="i-[mdi--delete-outline]"
                          (onClick)="removePlayerFromPreconfig(preconfig.id, playerId)"
                        />
                      </div>
                    }
                    @if (preconfig.playerIds.length === 0) {
                      <div class="px-4 py-2 text-center leading-8">
                        {{ translations.events_timeslot_preconfigNoPlayers() }}
                      </div>
                    }
                    <div class="relative w-full p-2">
                      <p-dropdown
                        #preconfigPlayerDropdown
                        class="grow"
                        styleClass="flex"
                        [ngModel]="null"
                        [disabled]="isAddPlayerToPreconfigBusy()"
                        [options]="getAllPlayersExcept(preconfig.playerIds)"
                        optionLabel="name"
                        [filter]="true"
                        filterBy="name"
                        [resetFilterOnHide]="true"
                        (onChange)="
                          addPlayerToPreconfig(preconfig.id, $event.value.id);
                          preconfigPlayerDropdown.writeValue(null)
                        "
                      />
                      @if (isAddPlayerToPreconfigBusy()) {
                        <p-progressSpinner
                          styleClass="absolute w-8 h-8 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"
                          strokeWidth="6"
                        />
                      }
                    </div>
                  </p-accordionTab>
                }
              </p-accordion>
            }

            <h2 class="m-0 mt-4">
              {{ translations.events_timeslot_registeredPlayers() }} ({{
                timeslot.playerIds.length
              }})
            </h2>
            <div class="rounded-lg border-[1px] border-solid border-surface-d bg-surface-a">
              @for (playerId of timeslot.playerIds; track playerId; let index = $index) {
                <div
                  class="min-w-0 truncate border-0 border-solid border-surface-d px-4 py-2 leading-8 hover:bg-surface-c"
                  [class.border-t-[1px]]="index > 0"
                >
                  @if (allUsers()[playerId]; as user) {
                    {{ user.name }}
                  } @else {
                    &lt;{{ translations.events_timeslot_unknownPlayer() }}&gt;
                    <span class="opacity-50">({{ playerId }})</span>
                  }
                </div>
              }
              @if (timeslot.playerIds.length === 0) {
                <div class="px-4 py-2 text-center leading-8">
                  {{ translations.events_timeslot_noPlayers() }}
                </div>
              }
            </div>
          }

          <p-button
            class="mt-12 self-center"
            severity="danger"
            [label]="translations.events_deleteTimeslot()"
            icon="i-[mdi--delete-outline]"
            (onClick)="deleteTimeslot()"
          />
        </div>
      }
    }
    @if (!event() && !timeslot()) {
      <div class="mt-16 flex flex-col items-center gap-8">
        <span class="i-[mdi--close-octagon] text-[8rem] text-red-500"></span>
        <h1 class="m-0 text-center">
          {{ event() ? translations.events_timeslot_notFound() : translations.events_notFound() }}
        </h1>
        <p-button
          [label]="event() ? translations.events_backToEvent() : translations.events_backToEvents()"
          icon="i-[mdi--arrow-left]"
          (onClick)="navigateBack()"
        />
      </div>
    }
  }
</div>
